service: tokenbalance
frameworkVersion: "2"

provider:
  name: aws
  runtime: python3.8
  lambdaHashingVersion: 20201221
  memorySize: 512
  timeout: 30
  region: ${file(./config.${self:provider.stage}.json):REGION}
  stage: ${opt:stage,'dev'}
  deploymentBucket:
    name: snet-serverless-artifacts # Deployment bucket name. Default is generated by the framework
    serverSideEncryption: AES256 # when using server-side encryption
    tags: # Tags that will be added to each of the deployment resources
      key1: tokenbalance-service
  deploymentPrefix: serverless
  tracing: true

custom:
  pythonRequirements:
    fileName: requirements.txt
    dockerizePip: true
    useDownloadCache: true
    useStaticCache: true
    cacheLocation: "/var/cache/serverless"
  prune:
    automatic: true
    includeLayers: true
    number: 5
  defaultLayers:
    - ${file(./config.${self:provider.stage}.json):MplaceCommonCode_Layer}
    - ${file(./config.${self:provider.stage}.json):MplaceCommonPythonLib_Layer}
    - ${file(./config.${self:provider.stage}.json):MplacePythonWeb3AndGrpc_Layer}
    - ${file(./config.${self:provider.stage}.json):SnetContract}
  defaultVpc:
    securityGroupIds:
      - ${file(./config.${self:provider.stage}.json):SG1}
      - ${file(./config.${self:provider.stage}.json):SG2}
    subnetIds:
      - ${file(./config.${self:provider.stage}.json):VPC1}
      - ${file(./config.${self:provider.stage}.json):VPC2}
  defaultCors:
    origin: ${file(./config.${self:provider.stage}.json):ORIGIN}
    headers:
      - Content-Type
      - X-Amz-Date
      - Authorization
      - X-Api-Key
      - X-Amz-Security-Token
      - X-Amz-User-Agent
      - x-requested-with

plugins:
  - serverless-offline
  - serverless-python-requirements
  - serverless-plugin-tracing
  - serverless-prune-plugin
  - serverless-aws-documentation

documentation:
  models:
    - name: "ErrorMessage"
      contentType: "application/json"
      schema: ${file(documentation/models/error.json)}
    - name: "SubmitUserQuestion"
      contentType: "application/json"
      schema: ${file(documentation/models/submit_question.json):SubmitUserQuestion}
    - name: "SubmitUserQuestionOutput"
      contentType: "application/json"
      schema: ${file(documentation/models/submit_question.json):SubmitUserQuestionOutput}
    - name: "GetTokenBalance"
      contentType: "application/json"
      schema: ${file(documentation/models/token_balance.json):GetTokenBalance}
    - name: "TokenBalanceOutput"
      contentType: "application/json"
      schema: ${file(documentation/models/token_balance.json):TokenBalanceOutput}

package:
  exclude:
    - .circleci/**
    - .gitignore/**
    - .serverless/**
    - requirements.txt
    - venv/**
    - config.ropsten.json
    - sls_deploy.sh
    - serverless.yml
    - test/**
    - tests/**
    - sql_script/**
    - service_status/**
    - dapp-user/**
    - repository/**
    - Readme.md
    - parse_events.sh
    - package.json
    - Dockerfile
    - License
    - heath_check.sh
    - node_modules/**

functions:
  get_token_balance:
    warmup: true
    handler: application/handlers/balance_handler.get_token_balance
    role: ${file(./config.${self:provider.stage}.json):ROLE}
    vpc: ${self:custom.defaultVpc}
    events:
      - http:
          path: /get-token-balance
          method: post
          cors: ${self:custom.defaultCors}
          documentation:
            summary: "Get token balance"
            description: "Get token balance from the snapshot"
            tags:
              - "tokenbalance"
            requestHeaders:
              - name: "Content-Type"
                description: "application/json"
            requestModels:
              "application/json": "GetTokenBalance"
            methodResponses:
              - statusCode: "200"
                responseBody:
                  description: "Tokenbalance Data"
                responseModels:
                  "application/json": "TokenBalanceOutput"
              - statusCode: "500"
                responseModels:
                  "application/json": "ErrorMessage"
  submit_user_question:
    warmup: true
    handler: application/handlers/customer_handler.submit_question
    role: ${file(./config.${self:provider.stage}.json):ROLE}
    vpc: ${self:custom.defaultVpc}
    events:
      - http:
          path: /submit-question
          method: post
          cors: ${self:custom.defaultCors}
          documentation:
            summary: "Submit user question"
            description: "Submit user question"
            tags:
              - "tokenbalance"
            requestHeaders:
              - name: "Content-Type"
                description: "application/json"
            requestModels:
              "application/json": "SubmitUserQuestion"
            methodResponses:
              - statusCode: "200"
                responseBody:
                  description: "Submit user question"
                responseModels:
                  "application/json": "SubmitUserQuestionOutput"
              - statusCode: "500"
                responseModels:
                  "application/json": "ErrorMessage"

  update_token_balance:
    handler: application/handlers/balance_handler.update_token_balance
    role: ${file(./config.${self:provider.stage}.json):ROLE}
    vpc: ${self:custom.defaultVpc}
    layers: ${self:custom.defaultLayers}
    events:
      - schedule:
          rate: rate(10 minutes)
          name: ${file(./config.${self:provider.stage}.json):ENVIRONMENT}-update-token-balance
          description: 'Job for updating the token balance'
          enabled: true
